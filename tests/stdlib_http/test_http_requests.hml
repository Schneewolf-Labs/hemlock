// Test HTTP client requests against stdlib HttpServer
// No external dependencies - pure Hemlock!
// Requires: libwebsockets-dev installed and 'make stdlib' run

import { get, post, fetch, post_json, is_success, is_client_error, is_server_error, is_redirect, HttpServer } from "@stdlib/http";
import { sleep } from "@stdlib/time";

print("Testing HTTP client with HttpServer...");
print("");

let tests_passed = 0;
let tests_failed = 0;

// Create and configure HTTP server
let server_port = 18765;
let server = HttpServer("127.0.0.1", server_port);

// Define routes
server.route("GET", "/hello", fn(req) {
    return {
        status: 200,
        body: "Hello World",
        content_type: "text/plain"
    };
});

server.route("GET", "/json", fn(req) {
    return {
        status: 200,
        body: `{"test": true, "message": "hello", "number": 42}`,
        content_type: "application/json"
    };
});

server.route("POST", "/echo", fn(req) {
    return {
        status: 200,
        body: `{"received": "` + req.body + `"}`,
        content_type: "application/json"
    };
});

server.route("POST", "/json", fn(req) {
    return {
        status: 200,
        body: `{"success": true, "method": "POST"}`,
        content_type: "application/json"
    };
});

// Start server in background (will handle 5 requests)
async fn run_server(srv, count: i32) {
    srv.serve(count);
    return null;
}

let server_task = spawn(run_server, server, 5);

// Give server time to start
sleep(0.1);

let base_url = "http://127.0.0.1:" + server_port;

// Test 1: HTTP GET request for text
print("Test 1: HTTP GET request (text)");
try {
    let response = get(base_url + "/hello", []);

    assert(response != null, "Response should not be null");
    assert(response.status_code != null, "Status code should exist");
    assert(response.body != null, "Body should exist");

    if (is_success(response.status_code) && response.body.contains("Hello")) {
        print("✓ GET request successful (status: " + response.status_code + ")");
        tests_passed = tests_passed + 1;
    } else {
        print("✗ GET request failed with status: " + response.status_code);
        tests_failed = tests_failed + 1;
    }
} catch (e) {
    print("✗ GET request threw exception: " + e);
    tests_failed = tests_failed + 1;
}

print("");

// Test 2: HTTP GET request for JSON
print("Test 2: HTTP GET request (JSON)");
try {
    let response2 = get(base_url + "/json", []);

    assert(response2 != null, "Response should not be null");

    if (is_success(response2.status_code) && response2.body.contains("test")) {
        print("✓ GET JSON successful (status: " + response2.status_code + ")");
        tests_passed = tests_passed + 1;
    } else {
        print("✗ GET JSON failed with status: " + response2.status_code);
        tests_failed = tests_failed + 1;
    }
} catch (e) {
    print("✗ GET JSON threw exception: " + e);
    tests_failed = tests_failed + 1;
}

print("");

// Test 3: fetch() convenience function
print("Test 3: fetch() convenience function");
try {
    let body = fetch(base_url + "/hello");

    assert(body != null, "Body should not be null");
    assert(body.length > 0, "Body should have content");

    if (body.contains("Hello")) {
        print("✓ fetch() returned " + body.length + " bytes");
        tests_passed = tests_passed + 1;
    } else {
        print("✗ fetch() returned unexpected content");
        tests_failed = tests_failed + 1;
    }
} catch (e) {
    print("✗ fetch() threw exception: " + e);
    tests_failed = tests_failed + 1;
}

print("");

// Test 4: HTTP POST request
print("Test 4: HTTP POST request");
try {
    let response4 = post(base_url + "/echo", "test=data", []);

    assert(response4 != null, "Response should not be null");

    if (is_success(response4.status_code)) {
        print("✓ POST request successful (status: " + response4.status_code + ")");
        tests_passed = tests_passed + 1;
    } else {
        print("✗ POST request failed with status: " + response4.status_code);
        tests_failed = tests_failed + 1;
    }
} catch (e) {
    print("✗ POST request threw exception: " + e);
    tests_failed = tests_failed + 1;
}

print("");

// Test 5: 404 response handling
print("Test 5: 404 response handling");
try {
    let response5 = get(base_url + "/nonexistent", []);

    assert(response5 != null, "Response should not be null");

    if (response5.status_code == 404) {
        print("✓ 404 response handled correctly");
        tests_passed = tests_passed + 1;
    } else {
        print("✗ Expected 404, got: " + response5.status_code);
        tests_failed = tests_failed + 1;
    }
} catch (e) {
    print("✗ 404 request threw exception: " + e);
    tests_failed = tests_failed + 1;
}

// Wait for server to finish
join(server_task);
server.close();

print("");
print("========================================");
print("HTTP Request Tests Summary:");
print("  Passed: " + tests_passed);
print("  Failed: " + tests_failed);
print("========================================");

if (tests_failed > 0) {
    print("");
    print("Some tests failed. Common issues:");
    print("  - lws_wrapper.so not compiled (run: make stdlib)");
    print("  - libwebsockets not installed");
    print("  - Port " + server_port + " already in use");
}

print("");
assert(tests_failed == 0, "All HTTP request tests should pass");
